<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace= "com.used.example.mapper.AuctionMapper">

	<insert id="CreateAuction" parameterType="Auction">
		insert into auction(a_username, a_enddate, a_startprice, a_title, a_content )
					values(#{a_username},#{enddate},#{startprice},#{title},#{content})
					
		<selectKey resultType= "int" keyProperty="a_num" order="AFTER" >
			select last_insert_id()
		</selectKey>

	</insert>
	<insert id="CreateAP" parameterType="Auc_Pro">
	
		insert into auc_and_pro (a_num, p_num)
					values(#{a_num}, #{p_num})
	</insert>
	<insert id="CreateAddress" parameterType="Address">
		insert into address(ad_lat, ad_lon, ad_addr, ad_town, a_num)
					values(#{lat}, #{lon}, #{addr}, #{town}, #{a_num})
	</insert>
	
	
	
	
	
	<resultMap type="Picture" id="ListPi">
		<result property="p_num" column="p_num"/>
		<result property="pi_num" column="pi_num"/>
		<result property="pictureName" column="pi_name"/>
	</resultMap>
	
	<resultMap type="Product" id="ListPro">
		<result property="p_num" column="p_num"/>
		<result property="brand" column="p_brand"/>
		<result property="kind" column="p_kind"/>
		<result property="industry" column="p_industry"/>
		<result property="year" column="p_year"/>
		<collection property="picture" resultMap="ListPi"/>
	</resultMap>
	
	<resultMap type="Offer" id="ListOffer">
	
		<result property="o_num" column="o_num"/>
		<result property="a_num" column="a_num"/>
		<result property="o_username" column="o_username"/>
		<result property="price" column="o_price"/>
		<result property="time" column="o_time"/>
	
	</resultMap>
	
	<resultMap type="Like" id="ListLike">
		<result property="a_num" column="a_num"/>
		<result property="l_username" column="l_username"/>
	
	</resultMap>
	
	
	<resultMap id="ListMap" type="Auction">
		<id property="a_num" column="a_num"/>
		<result property="a_num" column="a_num"/>
		<result property="a_username" column="a_username"/>
		<result property="startdate" column="a_startdate"/>
		<result property="d_day" column="a_enddate"/>
		<result property="startprice" column="a_startprice"/>
		<result property="sale" column="a_sale"/>
		<result property="hits" column="a_hits"/>
		<result property="title" column="a_title"/>
		<result property="content" column="a_content"/>
		<association property="address" javaType="Address">
			<result property="ad_num" column="ad_num"/>
			<result property="a_num" column="a_num"/>
			<result property="lat" column="ad_lat"/>
			<result property="lon" column="ad_lon"/>
			<result property="addr" column="ad_addr"/>
			<result property="town" column="ad_town"/>
		</association>
		<collection property="like"  resultMap="ListLike"/>
		<collection property="offer" resultMap="ListOffer"/>
		<collection property="product" resultMap="ListPro"/>
	</resultMap>
	
	
	
	<select id="SaleList" parameterType="Auction" resultMap="ListMap">
		SELECT *
		FROM auction a
		LEFT JOIN offer b ON a.a_num = b.a_num
		LEFT JOIN address c ON a.a_num = c.a_num
		LEFT JOIN `like` d ON a.a_num = d.a_num
		LEFT JOIN auc_and_pro e ON a.a_num = e.a_num
		LEFT JOIN product f ON e.p_num = f.p_num 
		LEFT JOIN picture g ON f.p_num = g.p_num
		WHERE a_sale = #{sale} and a_username = #{a_username}
		ORDER BY a.a_num DESC	
	</select>
	
	
	
		<resultMap type="Picture" id="DetailPi">
			<result property="p_num" column="p_num"/>
			<result property="pi_num" column="pi_num"/>
			<result property="pictureName" column="pi_name"/>
		</resultMap>
	<resultMap type="Product" id="DetailPro">
		<result property="p_num" column="p_num"/>
		<result property="brand" column="p_brand"/>
		<result property="kind" column="p_kind"/>
		<result property="industry" column="p_industry"/>
		<result property="year" column="p_year"/>
		<collection property="picture" resultMap="DetailPi"/>
	</resultMap>
	
	
	<resultMap type="Offer" id="DetailOffer">
	
		<result property="o_num" column="o_num"/>
		<result property="a_num" column="a_num"/>
		<result property="o_username" column="o_username"/>
		<result property="price" column="o_price"/>
		<result property="time" column="o_time"/>
	
	</resultMap>
	
		<resultMap type="Like" id="DetailLike">
		<result property="a_num" column="a_num"/>
		<result property="l_username" column="l_username"/>
	
	</resultMap>
	
	
	<resultMap id="DetailMap" type="Auction">
		<id property="a_num" column="a_num"/>
		<result property="a_num" column="a_num"/>
		<result property="a_username" column="a_username"/>
		<result property="startdate" column="a_startdate"/>
		<result property="d_day" column="a_enddate"/>
		<result property="startprice" column="a_startprice"/>
		<result property="sale" column="a_sale"/>
		<result property="hits" column="a_hits"/>
		<result property="title" column="a_title"/>
		<result property="content" column="a_content"/>
		<association property="address" javaType="Address">
			<result property="ad_num" column="ad_num"/>
			<result property="a_num" column="a_num"/>
			<result property="lat" column="ad_lat"/>
			<result property="lon" column="ad_lon"/>
			<result property="addr" column="ad_addr"/>
			<result property="town" column="ad_town"/>
		</association>
		<collection property="like"  resultMap="DetailLike"/>
		<collection property="offer" resultMap="DetailOffer"/>
		<collection property="product" resultMap="DetailPro"/>
	</resultMap>
	
	
	
	<select id="AucDetail" parameterType="int" resultMap="DetailMap">
		SELECT *
		FROM auction a
		LEFT JOIN offer b ON a.a_num = b.a_num
		LEFT JOIN address c ON a.a_num = c.a_num
		LEFT JOIN `like` d ON a.a_num = d.a_num 
		LEFT JOIN auc_and_pro e ON a.a_num = e.a_num
		LEFT JOIN product f ON e.p_num = f.p_num 
		LEFT JOIN picture g ON f.p_num = g.p_num
		WHERE a.a_num = #{a_num} 
	</select>
	
	
	<update id="AucEdit" parameterType="Auction">
		UPDATE  auction a 
			LEFT JOIN address b ON  a.a_num = b.a_num
			LEFT JOIN auc_and_pro c ON a.a_num = c.a_num
			LEFT JOIN product d ON  c.p_num = d.p_num
		SET     a.a_content= #{content},
				a.a_title = #{title},
				a.a_enddate= #{enddate},
				a.a_startprice=#{startprice},
				b.ad_lat= #{address.lat},
				b.ad_lon= #{address.lon},
				b.ad_addr= #{address.addr},
				b.ad_town= #{address.town},
				d.p_brand= #{pro.brand},
				d.p_kind = #{pro.kind},
				d.p_industry= #{pro.industry},
				d.p_year= #{pro.year}		
		WHERE a.a_num = #{a_num}
		
	
	</update>
	<delete id="AucDelete" parameterType="int">
		DELETE a.*, b.*, c.*, d.*, e.*, f.*, g.*
		FROM auction a
		LEFT JOIN offer b ON a.a_num = b.a_num
		LEFT JOIN address c ON a.a_num = c.a_num
		LEFT JOIN `like` d ON a.a_num = d.a_num 
		LEFT JOIN auc_and_pro e ON a.a_num = e.a_num
		LEFT JOIN product f ON e.p_num = f.p_num 
		LEFT JOIN picture g ON f.p_num = g.p_num
		WHERE a.a_num = #{a_num}

	</delete>
	
	<select id="TopList" parameterType="address" resultMap="ListMap">
		SELECT	*,
						
			  	(
			      	6371 * acos (
			      	cos ( radians(#{lat}) )
			      	* cos( radians( ad_lat ) )
			      	* cos( radians( ad_lon ) - radians(#{lon}) )
			      	+ sin ( radians(#{lat}) )
			      	* sin( radians( ad_lat ) )
			    	)
			   
				) AS distance
		FROM auction a
		LEFT JOIN address b ON b.a_num = a.a_num
		LEFT JOIN auc_and_pro c ON  c.a_num = a.a_num
		LEFT JOIN product d ON d.p_num = c.p_num
		LEFT JOIN picture e ON e.p_num = d.p_num
		HAVING DISTANCE &lt; 300
		ORDER BY distance ASC, a.a_hits DESC
		LIMIT 10
	
	</select>
	<select id="IndustryList" parameterType="String" resultMap="ListMap">
	
	
			SELECT	*,
						
			  	(
			      	6371 * acos (
			      	cos ( radians(#{lat}) )
			      	* cos( radians( ad_lat ) )
			      	* cos( radians( ad_lon ) - radians(#{lon}) )
			      	+ sin ( radians(#{lat}) )
			      	* sin( radians( ad_lat ) )
			    	)
				) AS distance
		FROM auction a
		LEFT JOIN address b ON b.a_num = a.a_num
		LEFT JOIN auc_and_pro c ON  c.a_num = a.a_num
		LEFT JOIN product d ON d.p_num = c.p_num
		LEFT JOIN picture e ON e.p_num = d.p_num
		WHERE d.p_industry = #{industry}
		ORDER BY distance ASC
		LIMIT 10
	</select>
	
	<select id="KindList" parameterType="String" resultMap="ListMap">
	
	
			SELECT	*,
						
			  	(
			      	6371 * acos (
			      	cos ( radians(#{lat}) )
			      	* cos( radians( ad_lat ) )
			      	* cos( radians( ad_lon ) - radians(#{lon}) )
			      	+ sin ( radians(#{lat}) )
			      	* sin( radians( ad_lat ) )
			    	)
				) AS distance
		FROM auction a
		LEFT JOIN address b ON b.a_num = a.a_num
		LEFT JOIN auc_and_pro c ON  c.a_num = a.a_num
		LEFT JOIN product d ON d.p_num = c.p_num
		LEFT JOIN picture e ON e.p_num = d.p_num
		WHERE d.p_kind = #{kind}
		ORDER BY distance ASC
		LIMIT 10
	</select>
	

</mapper>